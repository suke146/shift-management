<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç† - ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .admin-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-box {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            background: #f5f5f5;
            border-left: 4px solid #2196F3;
        }
        .status-box.success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
            color: #2e7d32;
        }
        .status-box.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .status-box.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
            color: #e65100;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-large {
            padding: 15px 30px;
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }
        .info-section {
            margin: 20px 0;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 4px;
        }
        .info-section h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .code-block {
            background: #263238;
            color: #aed581;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-card">
            <h1>ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h1>
            <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã€åˆæœŸåŒ–ã‚„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>
            
            <div class="btn-group" style="margin: 20px 0;">
                <button onclick="checkDatabase()" class="btn btn-secondary btn-large">
                    ğŸ“Š çŠ¶æ…‹ç¢ºèª
                </button>
                <button onclick="window.location.href='index.php'" class="btn btn-primary btn-large">
                    ğŸ  ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                </button>
            </div>
            
            <div id="status-display"></div>
        </div>

        <div class="admin-card">
            <h2>âš™ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ</h2>
            
            <div class="info-section">
                <h3>ğŸ†• åˆæœŸåŒ–ï¼ˆinit_db.phpï¼‰</h3>
                <p>æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã™ã€‚</p>
                <p><strong>å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:</strong> åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã®æ™‚</p>
            </div>
            
            <button onclick="executeScript('init')" class="btn btn-success btn-large">
                âœ¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–
            </button>
            
            <hr style="margin: 30px 0;">
            
            <div class="info-section">
                <h3>ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆmigrate_db.phpï¼‰</h3>
                <p>æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é€±å˜ä½ã‹ã‚‰åŠæœˆå˜ä½ã«å¤‰æ›ã—ã¾ã™ã€‚ç¢ºå®šã‚·ãƒ•ãƒˆã¯ä¿æŒã•ã‚Œã¾ã™ãŒã€æå‡ºæ¸ˆã¿ã‚·ãƒ•ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p>
                <p><strong>å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:</strong> å¤ã„ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã¸ã®ç§»è¡Œæ™‚</p>
            </div>
            
            <button onclick="executeScript('migrate')" class="btn btn-warning btn-large">
                ğŸ”„ ã‚¹ã‚­ãƒ¼ãƒã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            </button>
            
            <hr style="margin: 30px 0;">
            
            <div class="info-section">
                <h3>ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆï¼ˆreset_db.phpï¼‰</h3>
                <p><strong style="color: #f44336;">âš ï¸ è­¦å‘Š:</strong> å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã€ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãªã‚Šã¾ã™ã€‚</p>
                <p><strong>å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:</strong> å®Œå…¨ã«ã‚„ã‚Šç›´ã—ãŸã„æ™‚ã®ã¿</p>
            </div>
            
            <button onclick="executeScript('reset')" class="btn btn-danger btn-large" 
                    style="background: #f44336;">
                âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨å‰Šé™¤ï¼‰
            </button>
        </div>

        <div class="admin-card">
            <h2>ğŸ“– ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•</h2>
            
            <details style="margin: 10px 0;">
                <summary style="cursor: pointer; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <strong>âŒ ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã€Œé€šä¿¡ã‚¨ãƒ©ãƒ¼ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹</strong>
                </summary>
                <div style="padding: 15px;">
                    <p><strong>åŸå› :</strong> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„</p>
                    <p><strong>è§£æ±º:</strong> ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                </div>
            </details>
            
            <details style="margin: 10px 0;">
                <summary style="cursor: pointer; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <strong>âš ï¸ ã€Œå¤ã„ã‚¹ã‚­ãƒ¼ãƒã§ã™ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹</strong>
                </summary>
                <div style="padding: 15px;">
                    <p><strong>åŸå› :</strong> é€±å˜ä½ã®ã‚¹ã‚­ãƒ¼ãƒã®ã¾ã¾</p>
                    <p><strong>è§£æ±º:</strong> ã€Œã‚¹ã‚­ãƒ¼ãƒã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                </div>
            </details>
            
            <details style="margin: 10px 0;">
                <summary style="cursor: pointer; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <strong>ğŸ”„ å®Œå…¨ã«ã‚„ã‚Šç›´ã—ãŸã„</strong>
                </summary>
                <div style="padding: 15px;">
                    <p><strong>æ‰‹é †:</strong></p>
                    <ol>
                        <li>ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼‰</li>
                        <li>ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆæ–°è¦ä½œæˆï¼‰</li>
                    </ol>
                </div>
            </details>
        </div>
    </div>

    <script>
        async function checkDatabase() {
            const statusDiv = document.getElementById('status-display');
            statusDiv.innerHTML = '<div class="status-box">ç¢ºèªä¸­...</div>';
            
            try {
                const response = await fetch('test_db.php');
                const data = await response.json();
                
                let statusClass = 'success';
                if (data.status === 'error') statusClass = 'error';
                if (data.status === 'warning') statusClass = 'warning';
                
                let html = `<div class="status-box ${statusClass}">`;
                html += `<strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${data.message}\n\n`;
                html += `<strong>è©³ç´°:</strong>\n`;
                html += JSON.stringify(data.checks, null, 2);
                html += `</div>`;
                
                // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                if (!data.checks.tables || data.checks.tables.length === 0) {
                    html += '<div class="status-box error">';
                    html += '<strong>âš ï¸ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¿…è¦:</strong> ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚\n';
                    html += 'ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
                    html += '</div>';
                } else if (data.checks.schema_version && data.checks.schema_version.includes('old')) {
                    html += '<div class="status-box warning">';
                    html += '<strong>âš ï¸ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¿…è¦:</strong> å¤ã„ã‚¹ã‚­ãƒ¼ãƒã§ã™ã€‚\n';
                    html += 'ã€Œã‚¹ã‚­ãƒ¼ãƒã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
                    html += '</div>';
                } else if (data.status === 'ok') {
                    html += '<div class="status-box success">';
                    html += '<strong>âœ… æ­£å¸¸:</strong> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚\n';
                    html += 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã£ã¦ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚';
                    html += '</div>';
                }
                
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-box error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        async function executeScript(action) {
            const confirmMessages = {
                'init': 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚',
                'migrate': 'ã‚¹ã‚­ãƒ¼ãƒã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã‹ï¼Ÿ\n\næå‡ºæ¸ˆã¿ã‚·ãƒ•ãƒˆã¯å‰Šé™¤ã•ã‚Œã€ç¢ºå®šã‚·ãƒ•ãƒˆã¯ä¿æŒã•ã‚Œã¾ã™ã€‚',
                'reset': 'âš ï¸ è­¦å‘Š: å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼\n\næœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ'
            };
            
            if (!confirm(confirmMessages[action])) {
                return;
            }
            
            const statusDiv = document.getElementById('status-display');
            statusDiv.innerHTML = '<div class="status-box">å®Ÿè¡Œä¸­...</div>';
            
            const scripts = {
                'init': 'init_db.php',
                'migrate': 'migrate_db.php',
                'reset': 'reset_db.php'
            };
            
            try {
                const response = await fetch(`execute_db_script.php?script=${action}`);
                const text = await response.text();
                
                statusDiv.innerHTML = `<div class="status-box success">
                    <strong>å®Ÿè¡Œçµæœ:</strong>\n${text}
                </div>`;
                
                // å®Œäº†å¾Œã€çŠ¶æ…‹ã‚’å†ç¢ºèª
                setTimeout(() => {
                    checkDatabase();
                }, 1000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-box error">
                    <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}
                </div>`;
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', checkDatabase);
    </script>
</body>
</html>
